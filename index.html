<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>?šŒ it's seoul ...</title>
    <style>
        /* ê¸°ë³¸ ?¤í???ë°?ì»¨í…Œ?´ë„ˆ */


/* index.html ?Œì¼??<style> ?œê·¸ ?´ë? */

.asset-key-highlight { 
    color: #004085; /* ì§„í•œ ?Œë???ê¸€??*/ 
    font-weight: 900; /* ë§¤ìš° ?ê»ê²?ê°•ì¡° */
    font-size: 1.0em; /* ì£¼ë? ?ìŠ¤?¸ë³´???´ì§ ?¬ê²Œ */
    background-color: #cce5ff; /* ?°í•œ ?Œë???ë°°ê²½ */
    padding: 2px 5px; /* ?´ë? ?¬ë°± */
    border-radius: 3px; /* ëª¨ì„œë¦??¥ê?ê²?*/
    display: inline-block; /* ?ìŠ¤???ˆë¹„ë§Œí¼ë§?ë°°ê²½ ?ìš© */
}

/* ê¸°ë³¸ ?¤í???ë°?ì»¨í…Œ?´ë„ˆ */
body { 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;
    line-height: 1.6; 
    padding: 0; /* â¬…ï¸ body??ê¸°ë³¸ padding??0?¼ë¡œ ?¤ì • */
    margin: 0; /* â¬…ï¸ body??ê¸°ë³¸ margin??0?¼ë¡œ ?¤ì • */
    background-color: #f4f7f9; 
}
.main-container { 
    /* 1. max-width ?œê±°: ìµœë? ?ˆë¹„ ?œí•œ ?´ì œ */
    max-width: 100%; 
    /* 2. ì¤‘ì•™ ?•ë ¬ ë°??¬ë°± ?œê±° */
    margin: 0; /* â¬…ï¸ ì¤‘ì•™ ?•ë ¬ ?œê±° */
    /* 3. ?´ë? ?¬ë°±?€ ? ì??˜ê±°??ì¤„ì¼ ???ˆìŠµ?ˆë‹¤. (?”ì²­???°ë¼ 0?¼ë¡œ ë³€ê²? */
    padding: 1rem 1rem; /* â¬…ï¸ ì¢Œìš° ?¨ë”©??ì¤„ì´ê±°ë‚˜ ?œê±° */
    
    background: white; 
    /* ?„ì²´ ?”ë©´??ê½?ì±„ìš¸ ?ŒëŠ” ?Œë‘ë¦¬ë‚˜ ê·¸ë¦¼?ê? ë¶€?ì—°?¤ëŸ¬?????ˆì–´ ?œê±°/ì¡°ì •?˜ëŠ” ê²ƒì´ ?¼ë°˜?ì…?ˆë‹¤. */
    border-radius: 0; 
    box-shadow: none; 
}
        }
        h1 { color: #333; font-size: 1.5rem; margin-bottom: 0.5rem; text-align: center; }
        h2 { color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 1rem; }
        
        input, textarea { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box;
        }
        
        /* ë²„íŠ¼ ?¤í???*/
        .btn-group { margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end; }
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            flex-grow: 1; 
        }
        .btn-bottom {
            flex-grow: 0; 
        }
        .btn:disabled {
            background-color: #cccccc !important;
            cursor: not-allowed;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        
        /* ?Œì´ë¸??¤í???*/
        .incident-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .incident-table th, .incident-table td {
            padding: 1px 5px; 
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.8em;
            white-space: nowrap; 
        }
        .incident-table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
            font-size: 0.8em; /* â­?ì¶”ê?: ?¤ë” ê¸€ê¼??¬ê¸° ?•ì¶• */
        }
        .incident-table td {
      
            color: #000; 
            font-size: 0.8em; /* â­?ì¶”ê?: ë³¸ë¬¸ ê¸€ê¼??¬ê¸° ?•ì¶• */
        }

        .incident-table tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }

        /* ?íƒœ ?œì‹œ */
        .status-success { color: #28a745; font-weight: bold; } 
        .status-failure { color: #dc3545; font-weight: bold; } 
        .status-offline { color: #ffc107; font-weight: bold; } 
        .status-pending { color: #6c757d; } 
        .status-info { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #eee;} 

        /* ê¸°ì? ?•ë¥˜???•ë³´ */
        #standardInfo {
            font-size: 1.0rem;
            margin-bottom: 5px;
            padding: 5px 15px;
            border: 1px solid #007bff;
            border-radius: 8px;
            background-color: #e6f2ff;

    /* â­?ì¶”ê?: ?€?´í?????ì¤„ë¡œ ê°•ì œ?˜ê³  ?˜ì¹˜???ìŠ¤?¸ëŠ” ?¨ê? */
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 


        }
        #standardInfo .location-success { color: #007bff; font-weight: bold; }
        #standardTitle { 
                  
    /* â­?ì¶”ê?: ê¸€ê¼??¬ê¸° ?•ì¶• ë°?ì¤?ë°”ê¿ˆ ë°©ì? */
    font-size: 0.9em; 
    white-space: nowrap;
    overflow: hidden; 
    text-overflow: ellipsis; 

                           } 

        /* ëª©ë¡???¼ë°˜ ê¸€?ìƒ‰ */
        .incident-text { 
            color: #000; 
            font-weight: normal; 
        }
        /* ì§„í–‰?¬í•­ ?Œë???*/
        .action-text {
            color: #007bff; 
            font-weight: bold;
        }
        /* ?ˆë¡œ???•ë¥˜???€???‰ìƒ - ?”ì²­ ë°˜ì˜ */
        .type-color { 
        color: #0056b3; /* ì§„í•œ ?Œë‘ */ 
        font-weight: bold; 
        }
        /* ëª¨ë‹¬ ?¤í???*/
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 25px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-message { margin-top: 15px; padding: 10px; border-radius: 4px; background-color: #fff3cd; color: #856404; display: none; }
        .error { color: #dc3545; font-weight: bold; }
        .history-item { padding: 8px; border-bottom: 1px dashed #eee; font-size: 0.9em; }
        .history-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

    <div class="main-container">
        <h1>?šŒ it's seoul ...</h1>

        <div id="standardInfo">
            <div id="standardTitle">ë¡œë”© ì¤?..</div>
        </div>

        <div id="incidentList">
            ëª©ë¡ ë¡œë“œ ì¤?..
        </div>

        <p style="margin-top: 20px; font-size: 0.9em; color: #6c757d;">
            * ??ª©?´ë¦­ : ?œë²ˆ-ê±°ë¦¬, ?ë²ˆ-?œì„¤ë¬??¸ë??•ë³´,ì§„í–‰?¬í•­ ê´€ë¦?
        </p>
        
        <div class="btn-group" style="margin-top: 25px; justify-content: flex-start;">
            <button class="btn btn-secondary btn-bottom" onclick="reloadMainList()">?”„?ˆë¡œê³ ì¹¨</button>
            <button class="btn btn-primary btn-bottom" onclick="openModal('batchModal')">1. ?¥ì•  ?¼ê´„ ?±ë¡</button>
            <button class="btn btn-primary btn-bottom" onclick="openModal('manualModal')">2. ?¥ì•  ?˜ë™ ?±ë¡</button>
        </div>
    </div>

    <div id="batchModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('batchModal')">&times;</span>
            <h2>?¥ì•  ?¼ê´„?±ë¡</h2>
            <p>BIT ?¥ì• ê³µì? ë´‡ì„ ë³µì‚¬?˜ì—¬ ë¶™ì—¬?£ìœ¼?¸ìš”.</p>
            <textarea id="sampleText" rows="10" placeholder="?ˆì‹œ: [ì¢…ë¥˜] 02-223 09-27 10:15 / [ì¢…ë¥˜] 01-118 09-27 13:00"></textarea>
            <div id="batchMessage" class="modal-message"></div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="processBatchAddition()">?¼ê´„ ?±ë¡ : ë³µêµ¬?„ë£Œê±´ì? ?? œ?©ë‹ˆ??</button>
            </div>
        </div>
    </div>

     <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('detailModal')">&times;</span>
             <h2>?ì„¸ ?•ë³´ ë°?ì§„í–‰ ?„í™©</h2>                                             
             <div class="status-info"> 
                <p><strong id="detailStopId">N/A</strong> / <strong id="detailStopName">N/A</strong> /<strong id="detailCurrentStatus">N/A</strong>/<strong id="detailTime">N/A</strong></p> 
             </div>
            
            <h3 style="margin-top: 15px;">?œì„¤ë¬??¸ë? ?•ë³´</h3>
             <div class="status-info" style="font-size: 0.9em; background-color: #f0f8ff; border: 1px solid #cceeff;">
                <p>?œì„¤ë¬¼í‚¤: <strong id="detailAssetKey" class="asset-key-highlight">N/A</strong> / ?¬ì—…? í˜•: <strong id="detailBusinessType">N/A</strong></p>
                <p>?”ìŠ¤?Œë ˆ?? <strong id="detailAssetType1">N/A</strong></p>
                <p>?•ë¥˜?¥ëª…: <strong id="detailAssetName">N/A</strong> / ?œì„¤ë¬¼ìœ ?? <strong id="detailAssetType">N/A</strong></p>
                <p>?µì‹ ë°©ì‹: <strong id="detailCommMethod">N/A</strong> / ?µì‹ ??? í˜•: <strong id="detailCommType">N/A</strong></p>
                <p>?¬ì—…???´ë¦„: <strong id="detailOperator">N/A</strong> / ?œì¡°?? <strong id="detailManufacturer">N/A</strong></p>
                <p>BIT?œí’ˆì¢…ë¥˜: <strong id="detailBITType">N/A</strong> / BIT?¬ìš©?¬ë?: <strong id="detailBITUsage">N/A</strong> / ?„ì  ?¥ì• ê±´ìˆ˜: <strong id="detailIncidentCount" style="color: #dc3545;">N/A</strong></p>
             </div>
           
            <h3>ì§„í–‰?¬í•­ ê´€ë¦?/h3>
            <textarea id="actionText" rows="4" placeholder="ì§„í–‰?¬í•­???…ë ¥/?˜ì •?˜ì„¸?? ? ê·œ ?±ë¡ ?œì—???„ìˆ˜?…ë‹ˆ??"></textarea>
            <div id="actionMessage" class="modal-message"></div>
            
            <div class="btn-group">
                <button id="btnDetailUpdate" class="btn btn-primary" onclick="updateAction('UPDATE_ACTION')">ì§„í–‰?¬í•­ ?˜ì •</button>
                <button id="btnDetailDelete" class="btn btn-danger" onclick="deleteIncident()">ì¡°ì¹˜?„ë£Œ ?? œ</button>
                
                <button id="btnDetailCreate" class="btn btn-success" onclick="createIncidentFromDetail()">? ê·œ ?±ë¡ (?¥ì•  ?œì„±??</button>
            </div>

            <h3 style="margin-top: 20px;">?ˆìŠ¤? ë¦¬</h3>
            <div id="historyList">?ˆìŠ¤? ë¦¬ ?†ìŒ.</div>
        </div>
    </div>
    
    <div id="manualModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('manualModal')">&times;</span>
            <h2>?¥ì•  ?˜ë™ ?±ë¡</h2>
            <p>ë¯¼ì› ë°?BIT ?¥ì• ê³µì? ë´‡ì— ?†ëŠ” ?ë£Œë¥??±ë¡?©ë‹ˆ??</p>
            <input type="text" id="manualStopId" placeholder="?? 02-223">
            <textarea id="manualActionText" rows="4" placeholder="ë¯¼ì›ì²˜ë¦¬ ?ˆì •??ì§„í–‰?¬í•­???…ë ¥?˜ì„¸??"></textarea>
            <div id="manualMessage" class="modal-message"></div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="createManualIncident()">?¥ì•  ?˜ë™ ?±ë¡</button>
            </div>
        </div>
    </div>

<script>
    // ?š¨?š¨?š¨ NGROK ë¬¸ì œ ?´ê²°! Cloudflare Tunnel ì£¼ì†Œë¡?ë³€ê²½ë˜?ˆìŠµ?ˆë‹¤. ?š¨?š¨?š¨
    // ?°ë„??ê»ë‹¤ ì¼??Œë§ˆ????ì£¼ì†Œë¥??˜ë™?¼ë¡œ ?…ë°?´íŠ¸?´ì•¼ ?©ë‹ˆ??
    const API_BASE_URL = 'https://setup-rejected-trailers-dat.trycloudflare.com'; 

    let currentStandardId = '22-142'; 
    let activeStopId = null;         

    // ëª¨ë‹¬ ?œì–´ ?¨ìˆ˜
    function openModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
        if (modalId === 'batchModal') {
            document.getElementById('batchMessage').style.display = 'none';
        }
        if (modalId === 'manualModal') { 
            document.getElementById('manualMessage').style.display = 'none';
            document.getElementById('manualStopId').value = '';
            document.getElementById('manualActionText').value = '';
        }
    }
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }

    // ê¸°ì? ID ?¤ì • ë°?ëª©ë¡ ?ˆë¡œê³ ì¹¨
    function setStandardId(stopId) {
        currentStandardId = stopId;
        reloadMainList();
    }

    // ?œì„± ?¥ì•  ëª©ë¡???ˆë¡œ ë¡œë“œ?˜ëŠ” ?¨ìˆ˜ (GET ?”ì²­)
    function reloadMainList() {
        const standardTitle = document.getElementById('standardTitle');
        const incidentList = document.getElementById('incidentList');
        
        standardTitle.innerHTML = `?”„ ?„í™© ë¡œë“œ ì¤?..`; 

        fetch(API_BASE_URL + `/get_active_incidents?standard_id=${currentStandardId}`)
            .then(response => {
                // ?œë²„ ?‘ë‹µ ?íƒœ ?•ì¸: 404, 500 ?±ì˜ ?¤ë¥˜ë¥?ëª…í™•??ì§„ë‹¨
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} (${response.statusText})`);
                }
                return response.json();
            })
            .then(data => {
                // 1. ê¸°ì? ?•ë¥˜???•ë³´ ?…ë°?´íŠ¸ ë°??‰ìƒ ?ìš© (ê¸°ì¡´ ë¡œì§ ? ì?)
                const standardInfo = data.standard_info;
                if (standardInfo) {
                    let displayStopName = standardInfo.?•ë¥˜?Œëª…;
                    
                    // ?•ë¥˜?Œëª…???¬í•¨??ë§ˆì?ë§?ê´„í˜¸ ê·¸ë£¹(?•ë¥˜???€???•ë³´)??ì°¾ì•„ 'type-color' ?´ë˜?¤ë? ?ìš©?©ë‹ˆ??
                    displayStopName = displayStopName.replace(/(\s\([^)]+\))$/, (match, p1) => {
                        return `<span class="type-color">${p1}</span>`;
                    });

                    standardTitle.innerHTML = `???•ë¥˜??${displayStopName} <span class="location-success"></span>`;
                } else {
                    standardTitle.innerHTML = `??ê¸°ì? ?•ë¥˜?? ${currentStandardId} <span class="error">(?„ì¹˜ ë¡œë“œ ?¤íŒ¨ / DB ?•ì¸ ?„ìš”)</span>`;
                }
                
                // 2. ?œì„± ?¥ì•  ëª©ë¡ ?ì„± (?Œì´ë¸?ë·?
                let listHtml = `
                    <table class="incident-table">
                        <thead>
                            <tr>
                                <th style="width: 15%;">?•ë¥˜?¥ë²ˆ??/th>
                                <th style="width: 15%;">ë°œìƒ?œê°„</th>  
                                <th style="width: 15%;">ê±°ë¦¬</th>
                                <th style="width: 55%;">ì§„í–‰?¬í•­</th> 
                            </tr>
                        </thead>
                        <tbody>
                `;


                if (data.incidents.length === 0) {
                    listHtml += `<tr><td colspan="4" style="text-align: center; color: #6c757d;">?„ì¬ ?œì„± ?¥ì•  ëª©ë¡???†ìŠµ?ˆë‹¤.</td></tr>`;
                } else {
                    data.incidents.forEach(item => {
                        // ?š¨ ?˜ì •??ë¶€ë¶? item.action??null??ê²½ìš° ë¹?ë¬¸ì??'')??? ë‹¹?©ë‹ˆ??
                        const actionDisplay = item.action ? `<span class="action-text">${item.action}</span>` : '';
                        const distanceValue = item.distance_display ? item.distance_display.replace('km', '').trim() : 'N/A';

                        listHtml += `
                            <tr class="" 
                                onclick="setStandardId('${item.id}')"
                                ondblclick="showDetailModal('${item.id}')"
                                data-id="${item.id}">
                                
                                <td><span class="incident-text">${item.id}</span></td> 
                                <td><span class="incident-text">${item.time}</span></td>  
                                <td><span class="incident-text">${distanceValue}</span></td> 
                                <td>${actionDisplay}</td> </tr>
                        `;
                    });
                }
                listHtml += `</tbody></table>`;
                incidentList.innerHTML = listHtml;
            })

   

            .catch(error => {
                // ?’¡ ìµœì¢… ì§„ë‹¨ ë©”ì‹œì§€: POST ?”ì²­?€ ?±ê³µ?ˆë”?¼ë„ GET ?”ì²­?€ Ngrok ì£¼ì†Œê°€ ?€ë¦¬ë©´ ?¤íŒ¨?©ë‹ˆ??
                const errorMessage = error.message.includes("Unexpected token '<'") 
                                ? "Cloudflare ì£¼ì†Œ ë¶ˆì¼ì¹?ë§Œë£Œ ?ëŠ” ë°©í™”ë²?ë¬¸ì œ" 
                                : error.message;

                standardTitle.innerHTML = `???œë²„ ?°ê²° ?¤ë¥˜ (ì§„ë‹¨: ${errorMessage})`;
                incidentList.innerHTML = `<div style="padding: 15px; color: #dc3545;"><strong>GET ?”ì²­ ?¤íŒ¨:</strong> Cloudflare ì£¼ì†Œ?€ ?´ë¼?´ì–¸??ì£¼ì†Œê°€ ?¼ì¹˜?˜ëŠ”ì§€ ?•ì¸?˜ì„¸??</div>`;
                console.error("Fetch error:", error);
            });
    }


    // ?¼ê´„ ?±ë¡ ì²˜ë¦¬ (POST ?”ì²­)
    function processBatchAddition() {
        const sampleText = document.getElementById('sampleText').value;
        const batchMessage = document.getElementById('batchMessage');
        batchMessage.style.display = 'none';
        
        if (!sampleText) {
            batchMessage.innerHTML = `<span class="error">???¤ë¥˜:</span> ?ìŠ¤?¸ë? ?…ë ¥?´ì£¼?¸ìš”.`;
            batchMessage.style.display = 'block';
            return;
        }

        fetch(API_BASE_URL + '/process_sample', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sample_text: sampleText }) 
        })
        .then(response => {
            if (!response.ok) {
                // POST ?”ì²­??HTTP ?¤ë¥˜ ì½”ë“œ??ëª…í™•?˜ê²Œ ì§„ë‹¨
                throw new Error(`HTTP ${response.status} (${response.statusText})`);
            }
            return response.json();
        })
        .then(data => {
            batchMessage.innerHTML = `<span class="status-success">???±ê³µ:</span> ${data.message}`;
            batchMessage.style.display = 'block';
            // POST ?±ê³µ ??ëª©ë¡ ?ˆë¡œê³ ì¹¨ (GET ?”ì²­ ?¬ì‹œ??
            reloadMainList(); 
        })
        .catch(error => {
            batchMessage.innerHTML = `<span class="error">???µì‹  ?¤ë¥˜:</span> ?œë²„ ?°ê²° ?ëŠ” ?¼ìš°???¤ë¥˜ê°€ ?˜ì‹¬?©ë‹ˆ?? (ì§„ë‹¨: ${error.message})`;
            batchMessage.style.display = 'block';
            console.error("Batch post error:", error);
        });
    }
    
    // ?ì„¸ ?ì—… ?´ê¸° (GET)
    function showDetailModal(stopId) {
        activeStopId = stopId;
        openModal('detailModal');
        const actionMessage = document.getElementById('actionMessage');
        actionMessage.style.display = 'none';

        const btnUpdate = document.getElementById('btnDetailUpdate');
        const btnDelete = document.getElementById('btnDetailDelete');
        const btnCreate = document.getElementById('btnDetailCreate');
        
        btnUpdate.style.display = 'none';
        btnDelete.style.display = 'none';
        btnCreate.style.display = 'none';


        fetch(API_BASE_URL + `/incident_details/${stopId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} (${response.statusText})`);
                }
                return response.json();
            })

        .then(data => {
                const masterInfo = data.master_info;
                const activeData = data.active_data;
                const history = data.history;
                
                document.getElementById('detailStopId').textContent = masterInfo.id;
                document.getElementById('detailStopName').textContent = masterInfo.?•ë¥˜?Œëª…;
                
                // ?’¡ seoul_data ?•ë³´ ?œì‹œ ?’¡
                // ê°’ì´ null?´ë©´ '?•ë³´ ?†ìŒ'?¼ë¡œ ?œì‹œ
            document.getElementById('detailAssetKey').textContent = masterInfo["?œì„¤ë¬¼í‚¤"] || '';
            document.getElementById('detailBusinessType').textContent = masterInfo["?¬ì—…? í˜•"] || '';
            document.getElementById('detailAssetType1').textContent = masterInfo["?œì„¤ë¬¼ìœ ??1"] || '';

                document.getElementById('detailAssetName').textContent = masterInfo.?œì„¤ë¬¼ëª… || '';
                document.getElementById('detailAssetType').textContent = masterInfo.?œì„¤ë¬¼ìœ ??|| '';
                document.getElementById('detailCommMethod').textContent = masterInfo.?µì‹ ë°©ì‹ || '';
                document.getElementById('detailCommType').textContent = masterInfo.?µì‹ ??? í˜• || '';
                document.getElementById('detailOperator').textContent = masterInfo.?¬ì—…???´ë¦„ || '';
                document.getElementById('detailManufacturer').textContent = masterInfo.?œì¡°??|| '';
                document.getElementById('detailBITType').textContent = masterInfo.BIT?œí’ˆì¢…ë¥˜ || '';
                document.getElementById('detailBITUsage').textContent = masterInfo.BIT?¬ìš©?¬ë? || '';
                document.getElementById('detailIncidentCount').textContent = masterInfo.?¥ì• ê±´ìˆ˜ !== null ? masterInfo.?¥ì• ê±´ìˆ˜ : '';


               
                if (activeData) {
                    document.getElementById('detailCurrentStatus').innerHTML = `<span class="status-failure">${activeData.status}</span>`;
                    document.getElementById('detailTime').textContent = activeData.time;
                    // activeData.action??null??ê²½ìš° ë¹?ë¬¸ì??'')??? ë‹¹?©ë‹ˆ??
                    // placeholderê°€ ?ìš©?˜ì–´ ?ˆìœ¼ë¯€ë¡?ë¹?ë¬¸ì?´ë¡œ ?ì–´??ë¬¸êµ¬ê°€ ?˜í??©ë‹ˆ??
                    document.getElementById('actionText').value = activeData.action || '';
                    
                    btnUpdate.style.display = 'block';
                    btnDelete.style.display = 'block';

                } else {
                    document.getElementById('detailCurrentStatus').innerHTML = '?œì„± ëª©ë¡???†ìŒ';
                    document.getElementById('detailTime').textContent = 'N/A';
                    document.getElementById('actionText').value = ''; 
                    
                    btnCreate.style.display = 'block';
                }

                const historyList = document.getElementById('historyList');
                historyList.innerHTML = '';
                if (history && history.length > 0) {
                    history.forEach(h => {
                        const statusClass = h.status === 'COMPLETED' ? 'status-success' : 'status-pending';
                        historyList.innerHTML += `
                            <div class="history-item">
                                [${h.time}] <span class="${statusClass}">${h.status}</span> - ${h.action || 'ì§„í–‰?¬í•­ ê¸°ë¡ ?†ìŒ'}
                            </div>
                        `;
                    });
                } else {
                    historyList.textContent = 'ê¸°ë¡???ˆìŠ¤? ë¦¬ê°€ ?†ìŠµ?ˆë‹¤.';
                }

            })
            .catch(error => {
                alert(`?ì„¸ ?•ë³´ ë¡œë“œ ì¤??¤ë¥˜ ë°œìƒ: ${error.message}`);
                closeModal('detailModal');
                console.error("Detail fetch error:", error);
            });
    }

    // ì§„í–‰?¬í•­ ?€???? œ/? ê·œ (POST)
    async function updateAction(actionType) {
        const actionText = document.getElementById('actionText').value;
        const actionMessage = document.getElementById('actionMessage');
        actionMessage.style.display = 'none';
        
        if (!actionText) {
            actionMessage.innerHTML = `<span class="error">???¤ë¥˜:</span> ${actionType === 'DELETE' ? '?? œ' : actionType === 'CREATE' ? '? ê·œ ?±ë¡' : '?˜ì •'} ??ì§„í–‰?¬í•­??ë°˜ë“œ???…ë ¥?´ì•¼ ?©ë‹ˆ??`;
            actionMessage.style.display = 'block';
            return;
        }

        try {
            const response = await fetch(API_BASE_URL + `/incident_details/${activeStopId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action_type: actionType, action_text: actionText })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status} (${response.statusText})`);
            }
            
            const data = await response.json();

            actionMessage.style.display = 'block';
            actionMessage.innerHTML = `<span class="status-success">???±ê³µ:</span> ${data.message}`;
            reloadMainList(); 
            if (actionType === 'DELETE' || actionType === 'CREATE') {
                setTimeout(() => closeModal('detailModal'), 1000); 
                activeStopId = null;
            } else {
                showDetailModal(activeStopId); 
            }
        } catch (error) {
            actionMessage.innerHTML = `<span class="error">???µì‹  ?¤ë¥˜:</span> ?œë²„ ?°ê²° ?ëŠ” ?¼ìš°???¤ë¥˜ê°€ ?˜ì‹¬?©ë‹ˆ?? (ì§„ë‹¨: ${error.message})`;
            console.error("Action post error:", error);
        }
    }

    // [?? œ] ?˜í¼ ?¨ìˆ˜ (?œì„± ?íƒœ?ì„œ ì¡°ì¹˜ ?„ë£Œ)
    function deleteIncident() { 
        if(confirm(`?•ë¥˜??ID ${activeStopId}ë¥??œì„± ëª©ë¡?ì„œ ?? œ?˜ê³  ì¡°ì¹˜ ?„ë£Œ ?íƒœë¡??ˆìŠ¤? ë¦¬??ê¸°ë¡?˜ì‹œê² ìŠµ?ˆê¹Œ?`)) {
            updateAction('DELETE'); 
        }
    }
    
    // [? ê·œ ?±ë¡] ?˜í¼ ?¨ìˆ˜ (ë¹„í™œ???íƒœ?ì„œ ?œì„±??
    function createIncidentFromDetail() { 
        if(confirm(`?•ë¥˜??ID ${activeStopId}ë¥??œì„± ?¥ì• ë¡?? ê·œ ?±ë¡?˜ì‹œê² ìŠµ?ˆê¹Œ?`)) {
            updateAction('CREATE'); 
        }
    }
    
    // ?˜ë™ ?±ë¡ ì²˜ë¦¬ (POST)
    function createManualIncident() { 
        const manualStopId = document.getElementById('manualStopId').value.trim();
        const manualActionText = document.getElementById('manualActionText').value;
        const manualMessage = document.getElementById('manualMessage');
        manualMessage.style.display = 'none';

        if (!manualStopId || !manualActionText) {
            manualMessage.innerHTML = `<span class="error">???¤ë¥˜:</span> ?•ë¥˜??ID?€ ì§„í–‰?¬í•­??ëª¨ë‘ ?…ë ¥?´ì•¼ ?©ë‹ˆ??`;
            manualMessage.style.display = 'block';
            return;
        }
        
        if(confirm(`?•ë¥˜??ID ${manualStopId}ë¥??œì„± ?¥ì• ë¡??˜ë™ ì¶”ê??˜ì‹œê² ìŠµ?ˆê¹Œ? ì§„í–‰?¬í•­???¨ê»˜ ?€?¥ë©?ˆë‹¤.`)) {
            fetch(API_BASE_URL + `/incident_details/${manualStopId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action_type: 'CREATE', action_text: manualActionText })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} (${response.statusText})`);
                }
                return response.json();
            })
            .then(data => {
                manualMessage.style.display = 'block';
                if (data.message.includes('?±ê³µ')) {
                    manualMessage.innerHTML = `<span class="status-success">???±ê³µ:</span> ${data.message}`;
                    reloadMainList();
                    setTimeout(() => closeModal('manualModal'), 1000);
                } else {
                    manualMessage.innerHTML = `<span class="error">???¤íŒ¨:</span> ${data.message || '?œë²„ ?¤ë¥˜'}`;
                }
            })
            .catch(error => {
                manualMessage.innerHTML = `<span class="error">???µì‹  ?¤ë¥˜:</span> ?œë²„ ?°ê²° ?ëŠ” Cloudflare ì£¼ì†Œ ë¶ˆì¼ì¹˜ê? ?˜ì‹¬?©ë‹ˆ??`;
                manualMessage.style.display = 'block';
                console.error("Manual create error:", error);
            });
        }
    }


    // ?˜ì´ì§€ ë¡œë“œ ??ì´ˆê¸° ê¸°ì? IDë¡??„í™© ?°ì´?°ë? ë°”ë¡œ ?œì‹œ
    window.onload = function() {
        reloadMainList();
    };
</script>

</body>
</html>