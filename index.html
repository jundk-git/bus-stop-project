<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚌 it's seoul ...</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    
    <style>
        /* 기본 스타일 및 컨테이너 (⭐원래대로 복원됨) */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6; 
            padding: 0; 
            margin: 0; 
            background-color: #f4f7f9; 
        }
        .main-container { 
            /* ⭐ 복원: 중앙 정렬 및 최대 너비 제한 */
            max-width: 1300px; 
            margin: 40px auto; 
            padding: 20px; 
            background-color: #ffffff; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); 
        }
        
        /* 제목 스타일 */
        h1 { 
            color: #343a40; 
            font-size: 1.5rem; 
            margin-bottom: 20px; 
            text-align: center;
            border-bottom: 2px solid #e9ecef; 
            padding-bottom: 10px;
        }
        h2, h3 { 
            color: #343a40; 
            border-bottom: 1px solid #e9ecef; 
            padding-bottom: 5px; 
            margin-top: 25px;
            margin-bottom: 15px; 
        }
        
        /* 입력 요소 및 버튼 스타일 */
        input, textarea { 
            width: 100%; 
            padding: 10px; 
            margin-bottom: 10px; 
            border: 1px solid #ced4da; 
            border-radius: 4px; 
            box-sizing: border-box;
        }
        
        .btn-group { margin-top: 15px; display: flex; gap: 10px; justify-content: flex-start; }
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        
        /* 테이블 스타일 (압축된 상태 유지) */
        .incident-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .incident-table th, .incident-table td {
            padding: 1px 5px; 
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.8em;
            white-space: nowrap; 
        }
        .incident-table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
            font-size: 0.8em;
        }
        .incident-table tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }

        /* 상태 및 텍스트 강조 */
        .asset-key-highlight { 
            color: #004085; 
            font-weight: 900; 
            font-size: 1.0em; 
            background-color: #cce5ff; 
            padding: 2px 5px; 
            border-radius: 3px; 
            display: inline-block; 
        }
        .action-text { color: #007bff; font-weight: bold; }
        .type-color { color: #0056b3; font-weight: bold; }
        
        /* 기준 정류장 정보 */
        #standardInfo { 
             font-size: 1.0rem; 
             margin: 0 0 15px 0;
             padding: 10px 15px; 
             border: 1px solid #007bff; 
             border-radius: 4px; 
             background-color: #e6f2ff;
             white-space: nowrap; 
             overflow: hidden; 
             text-overflow: ellipsis; 
        }
        #standardTitle { 
            font-size: 0.9em; 
            white-space: nowrap;
            overflow: hidden; 
            text-overflow: ellipsis; 
            line-height: 1.2;
        } 
        
        /* 모달 스타일 */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1050; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); 
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 25px;
            border: 1px solid #888;
            width: 90%; 
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .modal-content p {
            margin: 3px 0; 
            line-height: 1.3; 
        }
        
        /* 일괄/센터 등록 관련 스타일 */
        .large-modal { max-width: 800px; }
        .file-input-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .incident-table-container {
            max-height: 400px; 
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 0;
        }
        .modal-message { margin-top: 15px; padding: 10px; border-radius: 4px; background-color: #fff3cd; color: #856404; display: none; }
        .modal-message.status-error, .modal-message.error { background-color: #f8d7da; color: #721c24; }
        .modal-message.status-success { background-color: #d4edda; color: #155724; }
        .modal-message.status-warning { background-color: #fff3cd; color: #856404; }

        /* 센터 등록 결과 종류 색상 강조 */
        .center-status-danger { background-color: #f8d7da; color: #721c24; } 
        .center-status-warning { background-color: #fff3cd; color: #856404; } 
        .center-status-success { background-color: #d4edda; color: #155724; } 
    </style>
</head>
<body>

    <div class="main-container">
        <h1>🚌 it's seoul ...</h1>

        <div id="standardInfo">
            <div id="standardTitle">로딩 중...</div>
        </div>

        <div id="incidentList">
            목록 로드 중...
        </div>

        <p style="margin-top: 20px; font-size: 0.9em; color: #6c757d;">
            * 항목클릭 : 한번-거리, 두번-시설물 세부정보,진행사항 관리
        </p>
        
        <div class="btn-group" style="margin-top: 25px; justify-content: flex-start;">
            <button class="btn btn-secondary" onclick="reloadMainList()">🔄새로고침</button>
            <button class="btn btn-primary" onclick="openModal('batchModal')">1. 일괄</button>
            <button class="btn btn-primary" onclick="openModal('manualModal')">2. 건별</button>
            <button class="btn btn-primary" onclick="openModal('centerRegisterModal')">3. 센터</button>
        </div>
    </div>

    <div id="batchModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('batchModal')">&times;</span>
            <h2>1. 장애 일괄 등록</h2>
            <p>
                **종류, 정류장ID, 장애발생시각**을 **한 줄에 하나씩** 입력합니다. <br>
                공백이 여러 개이거나 탭이 섞여 있어도 상관없이 안정적으로 처리됩니다.
            </p>
            <div class="input-group">
                <label for="batchInputArea">장애 목록 입력 (예: `[독립] 06-117 10-21 16:44`)</label>
                <textarea id="batchInputArea" rows="10" placeholder="[독립]	06-117	10-21 16:44&#10;[알뜰]	10-219	10-20 16:01&#10;..."></textarea>
            </div>
            
            <div id="batchRegisterMessage" class="modal-message" style="display: none;"></div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="batchRegister()">일괄 등록 실행</button>
            </div>
        </div>
    </div>

    <div id="manualModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('manualModal')">&times;</span>
            <h2>2. 장애 수동 등록</h2>
            <p>민원 및 BIT 장애공지 봇에 없는 자료를 등록합니다.</p>
            <input type="text" id="manualStopId" placeholder="예: 02-223">
            <textarea id="manualActionText" rows="4" placeholder="민원처리 예정등 진행사항을 입력하세요."></textarea>
            <div id="manualMessage" class="modal-message"></div>
            <div class="btn-group">
                <button class="btn btn-success" onclick="createManualIncident()">장애 수동 등록</button>
            </div>
        </div>
    </div>

    <div id="centerRegisterModal" class="modal">
        <div class="modal-content large-modal"> 
            <span class="close" onclick="closeModal('centerRegisterModal')">&times;</span>
            <h2>3. 센터 등록 (CSV 파일 업로드)</h2>
            <p>각 유형별 CSV 파일을 선택하면, 파일 내 장애 항목(통신, 전원, 도어, 충격)이 있는 정류장의 목록을 확인합니다.</p>
            
            <form id="centerRegisterForm" enctype="multipart/form-data"> 
                <div class="file-input-group">
                    <label for="independent_file">1. 독립형 첨부파일 (선택 사항):</label>
                    <input type="file" id="independent_file" name="independent_file" accept=".csv">
                </div>
                
                <div class="file-input-group">
                    <label for="thrifty_file">2. 알뜰형 첨부파일 (선택 사항):</label>
                    <input type="file" id="thrifty_file" name="thrifty_file" accept=".csv">
                </div>
                
                <div class="file-input-group">
                    <label for="mini_file">3. 미니형 첨부파일 (선택 사항):</label>
                    <input type="file" id="mini_file" name="mini_file" accept=".csv">
                </div>
                
                <div id="centerRegisterMessage" class="modal-message"></div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="submitCenterRegister()">CSV 파일 처리</button>
                </div>
            </form>
            
            <div id="centerResultDisplay" style="margin-top: 20px;">
                <h3>처리 결과 목록
                       <button class="btn btn-secondary" onclick="copyCenterResultsToClipboard()" style="float: right; font-size: 0.8em;">📋 결과 복사</button>
                </h3>
                <div id="centerResultList" class="incident-table-container">
                    <p style="color: #6c757d;">파일 처리 후 결과가 여기에 표시됩니다.</p>
                </div>
            </div>
        </div>
    </div>


    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('detailModal')">&times;</span>
            <h3>상세 정보 및 진행 현황</h3>                                             
            <div class="status-info" style="font-size: 0.9em; background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px;"> 
                <p><strong id="detailStopId">N/A</strong> / <strong id="detailStopName">N/A</strong> / <strong id="detailTime">N/A</strong></p>
            </div>    
            <h3 style="margin-top: 15px;">시설물 세부 정보</h3>
                 <div class="status-info" style="font-size: 0.9em; background-color: #f0f8ff; border: 1px solid #cceeff; padding: 10px;">
                    <p><strong id="detailAssetKey" class="asset-key-highlight">N/A</strong> / <strong id="detailBusinessType">N/A</strong>
                    <p>디스플레이: <strong id="detailAssetType1">N/A</strong>
                    <p>정류장명: <strong id="detailAssetName">N/A</strong> / 시설물유형: <strong id="detailAssetType">N/A</strong>
                    <p>통신방식: <strong id="detailCommMethod">N/A</strong> / 통신사: <strong id="detailCommType">N/A</strong>
                    <p>사업자: <strong id="detailOperator">N/A</strong> / 제조자: <strong id="detailManufacturer">N/A</strong>
                    <p>제품종류: <strong id="detailBITType">N/A</strong> / BIT사용여부: <strong id="detailBITUsage">N/A</strong> / 장애누적: <strong id="detailIncidentCount" style="color: #dc3545;">N/A</strong>
                 </div>
               
                <h3>진행사항 관리</h3>
                <textarea id="actionText" rows="4" placeholder="진행사항을 입력/수정하세요. 신규 등록 시에도 필수입니다."></textarea>
                <div id="actionMessage" class="modal-message"></div>
                
                <div class="btn-group" style="justify-content: flex-end;">
                    <button id="btnDetailUpdate" class="btn btn-primary" onclick="updateAction('UPDATE_ACTION')">진행사항 수정</button>
                    <button id="btnDetailDelete" class="btn btn-danger" onclick="deleteIncident()">조치완료 삭제</button>
                    
                    <button id="btnDetailCreate" class="btn btn-success" onclick="createIncidentFromDetail()">신규 등록 (장애 활성화)</button>
                </div>

                <h3 style="margin-top: 20px;">히스토리</h3>
                <div id="historyList">히스토리 없음.</div>
            </div>
        </div>


    <script>
        // 🚨🚨🚨 서버 주소 설정 (사용자님의 마지막 주소 유지) 🚨🚨🚨
        const API_BASE_URL = 'https://yoga-itself-rugby-uncertainty.trycloudflare.com'; 

        let currentStandardId = '22-142'; 
        let activeStopId = null;         
        let centerResultsTextForCopy = ''; 
        let currentSortBy = 'distance';  

        // --- 헬퍼 함수 ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            // 모달 초기화
            if (modalId === 'batchModal') {
                document.getElementById('batchRegisterMessage').style.display = 'none';
            }
            if (modalId === 'manualModal') { 
                document.getElementById('manualMessage').style.display = 'none';
                document.getElementById('manualStopId').value = '';
                document.getElementById('manualActionText').value = '';
            }
            if (modalId === 'centerRegisterModal') {
                document.getElementById('centerRegisterMessage').style.display = 'none';
                document.getElementById('centerResultList').innerHTML = '<p style="color: #6c757d;">파일 처리 후 결과가 여기에 표시됩니다.</p>';
                centerResultsTextForCopy = '';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
        
        function setStandardId(stopId) {
            currentStandardId = stopId;
            reloadMainList();
        }
        
        function toggleSort(sortBy) {
            if (currentSortBy === sortBy) {
                // 이미 같은 기준이면 정렬 방향을 토글할 필요 없이, 그냥 다시 로드하면 거리/시간/ID 순으로 정렬됨
                // 여기서는 간단히 다시 로드만 수행
            } else {
                currentSortBy = sortBy;
            }
            reloadMainList();
        }

        // --- 메인 목록 로드 및 렌더링 ---
        function reloadMainList() {
            const standardTitle = document.getElementById('standardTitle');
            const incidentList = document.getElementById('incidentList');
            
            standardTitle.innerHTML = `🔄 현황 로드 중...`; 

            fetch(API_BASE_URL + `/get_active_incidents?standard_id=${currentStandardId}&sort_by=${currentSortBy}`)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP ${response.status} (${response.statusText}) - 응답: ${text.substring(0, 100)}...`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    const standardInfo = data.standard_info;
                    if (standardInfo) {
                        let displayStopName = standardInfo.정류소명;
                        displayStopName = displayStopName.replace(/(\s\([^)]+\))$/, (match, p1) => {
                            return `<span class="type-color">${p1}</span>`;
                        });
                        standardTitle.innerHTML = `✅ 정류장:${displayStopName} <span class="location-success"></span>`;
                    } else {
                        standardTitle.innerHTML = `❌ 기준 정류장: ${currentStandardId} <span class="error">(위치 로드 실패 / DB 확인 필요)</span>`;
                    }
                    
                    let listHtml = `
                        <table class="incident-table">
                            <thead>
                                <tr>
                                    <th style="width: 15%; cursor: pointer;" onclick="toggleSort('id')">정류장번호 ↓</th>
                                    <th style="width: 15%; cursor: pointer;" onclick="toggleSort('time')">발생시간 ↓</th>  
                                    <th style="width: 15%; cursor: pointer;" onclick="toggleSort('distance')">거리↓</th>
                                    <th style="width: 55%;">진행사항</th> 
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    if (data.incidents.length === 0) {
                        listHtml += `<tr><td colspan="4" style="text-align: center; color: #6c757d;">현재 활성 장애 목록이 없습니다.</td></tr>`;
                    } else {
                        data.incidents.forEach(item => {
                            const actionDisplay = item.action ? `<span class="action-text">${item.action}</span>` : '';
                            const distanceValue = item.distance_display ? item.distance_display.replace('km', '').trim() : 'N/A';

                            listHtml += `
                                <tr class="" 
                                    onclick="setStandardId('${item.id}')"
                                    ondblclick="showDetailModal('${item.id}')"
                                    data-id="${item.id}">
                                    
                                    <td><span class="incident-text">${item.id}</span></td> 
                                    <td><span class="incident-text">${item.time}</span></td>  
                                    <td><span class="incident-text">${distanceValue}</span></td> 
                                    <td>${actionDisplay}</td> </tr>
                            `;
                        });
                    }
                    listHtml += `</tbody></table>`;
                    incidentList.innerHTML = listHtml;
                })

                .catch(error => {
                    const errorMessage = error.message.includes("Cloudflare") 
                                    ? "Cloudflare 주소 불일치/만료 또는 방화벽 문제" 
                                    : error.message;

                    standardTitle.innerHTML = `❌ 서버 연결 오류 (진단: ${errorMessage})`;
                    incidentList.innerHTML = `<div style="padding: 15px; color: #dc3545;"><strong>GET 요청 실패:</strong> Cloudflare 주소와 클라이언트 주소가 일치하는지 확인하세요.</div>`;
                    console.error("Fetch error:", error);
                });
        }

        // --- 1. 일괄 등록 기능 ---
        function batchRegister() {
            const batchInputArea = document.getElementById('batchInputArea');
            const messageDisplay = document.getElementById('batchRegisterMessage');
            const incidentData = batchInputArea.value.trim();

            messageDisplay.style.display = 'none';
            messageDisplay.className = 'modal-message';
            messageDisplay.innerHTML = '처리 중...';
            messageDisplay.style.display = 'block';

            if (!incidentData) {
                messageDisplay.innerHTML = '<span class="error">❌ 오류:</span> 등록할 데이터가 없습니다.';
                messageDisplay.style.display = 'block';
                return;
            }
            
            fetch(API_BASE_URL + '/batch_register', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ incident_data: incidentData })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().catch(() => {
                        throw new Error(`HTTP ${response.status} (${response.statusText || '서버 응답 없음'})`);
                    })
                    .then(err => {
                        throw err;
                    });
                }
                return response.json();
            })
            .then(data => {
                let html = `<span class="status-success">✅ ${data.message}</span>`;
                if (data.fail_count > 0 && data.errors && data.errors.length > 0) {
                    html += `<br><details><summary style="color: #ffc107; cursor: pointer;">👉 실패 항목 ${data.fail_count}건 보기</summary>`;
                    html += '<ul>' + data.errors.map(err => `<li>${err}</li>`).join('') + '</ul>';
                    html += '</details>';
                    messageDisplay.className = 'modal-message status-warning'; 
                } else {
                    messageDisplay.className = 'modal-message status-success'; 
                }
                messageDisplay.innerHTML = html;
                
                reloadMainList(); 
            })
            .catch(error => {
                let errorMsg = '통신 오류';
                let detailMsg = '';
                
                if (error.error) {
                    errorMsg = error.error || '서버 내부 오류';
                    detailMsg = error.details || '상세 정보 없음';
                } else {
                    errorMsg = '통신 오류';
                    detailMsg = error.message;
                }

                messageDisplay.innerHTML = `<span class="error">❌ ${errorMsg}:</span> ${detailMsg}`;
                messageDisplay.style.display = 'block';
                messageDisplay.className = 'modal-message status-error';
                console.error("Batch register error:", error);
            });
        }
        
        // --- 2. 건별 수동 등록 기능 ---
        function createManualIncident() { 
            const manualStopId = document.getElementById('manualStopId').value.trim();
            const manualActionText = document.getElementById('manualActionText').value;
            const manualMessage = document.getElementById('manualMessage');
            manualMessage.style.display = 'none';

            if (!manualStopId || !manualActionText) {
                manualMessage.innerHTML = `<span class="error">❌ 오류:</span> 정류장 ID와 진행사항을 모두 입력해야 합니다.`;
                manualMessage.style.display = 'block';
                return;
            }
            
            if(confirm(`정류장 ID ${manualStopId}를 활성 장애로 수동 추가하시겠습니까?`)) {
                fetch(API_BASE_URL + `/incident_details/${manualStopId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action_type: 'CREATE', action_text: manualActionText })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().catch(() => {
                            throw new Error(`HTTP ${response.status} (${response.statusText})`);
                        }).then(err => {
                            throw err;
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    manualMessage.style.display = 'block';
                    if (data.message && data.message.includes('성공')) {
                        manualMessage.innerHTML = `<span class="status-success">✅ 성공:</span> ${data.message}`;
                        reloadMainList();
                        setTimeout(() => closeModal('manualModal'), 1000);
                    } else {
                        manualMessage.innerHTML = `<span class="error">❌ 실패:</span> ${data.message || '서버 오류'}`;
                    }
                })
                .catch(error => {
                    manualMessage.innerHTML = `<span class="error">❌ 통신 오류:</span> ${error.message}`;
                    manualMessage.style.display = 'block';
                    console.error("Manual create error:", error);
                });
            }
        }
        
        // --- 3. 센터 등록 (CSV 파일 처리) 기능 ---
        async function submitCenterRegister() {
            const form = document.getElementById('centerRegisterForm');
            const messageDisplay = document.getElementById('centerRegisterMessage');
            const resultList = document.getElementById('centerResultList');
            
            messageDisplay.style.display = 'none';
            messageDisplay.className = 'modal-message';
            resultList.innerHTML = `<p style="text-align: center; color: #6c757d; padding: 15px;">... 파일 처리 중 ...</p>`;

            const formData = new FormData(form);
            let fileCount = 0;
            
            for (const [key, value] of formData.entries()) {
                if (value instanceof File && value.size > 0) {
                    fileCount++;
                }
            }
            
            if (fileCount === 0) {
                messageDisplay.className = 'modal-message error';
                messageDisplay.innerHTML = `❌ 오류: 처리할 CSV 파일을 하나 이상 선택해야 합니다.`;
                messageDisplay.style.display = 'block';
                resultList.innerHTML = `<p style="text-align: center; color: #6c757d; padding: 15px;">파일 처리 후 결과가 여기에 표시됩니다.</p>`;
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + '/center_register', {
                    method: 'POST',
                    body: formData 
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: '응답 본문 없음' }));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                }
                
                const data = await response.json();
                messageDisplay.style.display = 'block';

                if (data.data && data.data.length > 0) {
                    messageDisplay.className = 'modal-message status-success';
                    messageDisplay.innerHTML = `✅ 성공: ${data.message}`;
                    displayCenterResults(data.data);
                } else {
                    messageDisplay.className = 'modal-message status-warning';
                    messageDisplay.innerHTML = `⚠️ 주의: ${data.message}`;
                    resultList.innerHTML = `<p style="text-align: center; color: #6c757d; padding: 15px;">${data.message}</p>`;
                    displayCenterResults([]); 
                }
                reloadMainList();
                
            } catch (error) {
                messageDisplay.className = 'modal-message error';
                messageDisplay.innerHTML = `❌ 통신/처리 오류: ${error.message}`;
                messageDisplay.style.display = 'block';
                resultList.innerHTML = `<p style="text-align: center; color: #dc3545; padding: 15px;">파일 처리 중 치명적인 오류가 발생했습니다.</p>`;
                console.error("Center register error:", error);
            }
        }
        
        function displayCenterResults(results) {
            const resultList = document.getElementById('centerResultList');
            centerResultsTextForCopy = "종 류   정류장ID   장애발생시각\n"; 
            
            let tableHtml = `
                <table class="incident-table small-text">
                    <thead>
                        <tr>
                            <th style="width: 25%;">종 류</th>
                            <th style="width: 35%;">정류장ID</th>
                            <th style="width: 40%;">장애발생시각</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (results.length === 0) {
                centerResultsTextForCopy = ''; 
                tableHtml += `<tr><td colspan="3" style="text-align: center; color: #6c757d; padding: 15px;">파일에서 장애 데이터가 발견되지 않았습니다.</td></tr>`;
            } else {
                results.forEach(item => {
                    const type_tag = item.type.replace(/\[|\]/g, ''); 
                    let tag_class = '';
                    if (type_tag === '독립') tag_class = 'center-status-danger'; 
                    else if (type_tag === '알뜰') tag_class = 'center-status-warning'; 
                    else if (type_tag === '미니') tag_class = 'center-status-success'; 
                    
                    tableHtml += `
                        <tr>
                            <td><span class="${tag_class}" style="padding: 2px 5px; border-radius: 3px;">${item.type}</span></td>
                            <td>${item.ars_id}</td>
                            <td>${item.time}</td>
                        </tr>
                    `;
                    centerResultsTextForCopy += `${item.type}   ${item.ars_id}   ${item.time}\n`;
                });
            }
            
            tableHtml += `</tbody></table>`;
            resultList.innerHTML = tableHtml;
        }

        function copyCenterResultsToClipboard() {
            const messageDisplay = document.getElementById('centerRegisterMessage');
            messageDisplay.style.display = 'block';

            const lines = centerResultsTextForCopy.trim().split('\n');
            const dataCount = lines.length - 1; 

            if (dataCount <= 0) { 
                messageDisplay.className = 'modal-message status-warning';
                messageDisplay.innerHTML = `⚠️ 주의: 복사할 내용이 없습니다.`;
                return; 
            }

            navigator.clipboard.writeText(centerResultsTextForCopy)
                .then(() => {
                    messageDisplay.className = 'modal-message status-success';
                    messageDisplay.innerHTML = `✅ 성공: 총 ${dataCount}건의 결과가 클립보드에 복사되었습니다.`;
                    setTimeout(() => messageDisplay.style.display = 'none', 2000);
                })
                .catch(err => {
                    messageDisplay.className = 'modal-message error';
                    messageDisplay.innerHTML = `❌ 복사 오류: 클립보드 접근 권한이 없거나 브라우저에서 지원하지 않습니다.`;
                    console.error('클립보드 복사 실패:', err);
                });
        }
        
        // --- 4. 상세 모달 기능 ---
        function showDetailModal(stopId) {
            const arsIdOnly = stopId.split(' ')[0];
            activeStopId = stopId;
            openModal('detailModal');
            const actionMessage = document.getElementById('actionMessage');
            actionMessage.style.display = 'none';

            const btnUpdate = document.getElementById('btnDetailUpdate');
            const btnDelete = document.getElementById('btnDetailDelete');
            const btnCreate = document.getElementById('btnDetailCreate');
            
            btnUpdate.style.display = 'none';
            btnDelete.style.display = 'none';
            btnCreate.style.display = 'none';

            fetch(API_BASE_URL + `/incident_details/${arsIdOnly}`)
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 404) {
                            return response.json().then(err => {
                                throw err;
                            });
                        }
                        throw new Error(`HTTP ${response.status} (${response.statusText})`);
                    }
                    return response.json();
                })
                .then(data => {
                    const masterInfo = data.master_info;
                    const activeData = data.active_data;
                    const history = data.history;
                    
                    document.getElementById('detailStopId').textContent = masterInfo.id;
                    document.getElementById('detailStopName').textContent = masterInfo.정류소명;
                    
                    document.getElementById('detailAssetKey').textContent = masterInfo["시설물키"] || 'N/A';
                    document.getElementById('detailBusinessType').textContent = masterInfo["사업유형"] || 'N/A';
                    document.getElementById('detailAssetType1').textContent = masterInfo["시설물유형.1"] || 'N/A';
                    document.getElementById('detailAssetName').textContent = masterInfo.시설물명 || 'N/A';
                    document.getElementById('detailAssetType').textContent = masterInfo.시설물유형 || 'N/A';
                    document.getElementById('detailCommMethod').textContent = masterInfo.통신방식 || 'N/A';
                    document.getElementById('detailCommType').textContent = masterInfo.통신사_유형 || 'N/A';
                    document.getElementById('detailOperator').textContent = masterInfo.사업자_이름 || 'N/A';
                    document.getElementById('detailManufacturer').textContent = masterInfo.제조자 || 'N/A';
                    document.getElementById('detailBITType').textContent = masterInfo.BIT제품종류 || 'N/A';
                    document.getElementById('detailBITUsage').textContent = masterInfo.BIT사용여부 || 'N/A';
                    document.getElementById('detailIncidentCount').textContent = masterInfo.장애건수 !== null ? masterInfo.장애건수 : '0';


                    if (activeData) {
                        document.getElementById('detailTime').textContent = activeData.time;
                        document.getElementById('actionText').value = activeData.action || '';
                        
                        btnUpdate.style.display = 'block';
                        btnDelete.style.display = 'block';

                    } else {
                        document.getElementById('detailTime').textContent = 'N/A';
                        document.getElementById('actionText').value = ''; 
                        
                        btnCreate.style.display = 'block';
                    }

                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = '';
                    if (history && history.length > 0) {
                        history.forEach(h => {
                            const statusClass = h.status === 'COMPLETED' ? 'status-success' : 'status-pending';
                            historyList.innerHTML += `
                                <div class="history-item">
                                    [${h.time}] <span class="${statusClass}">${h.status}</span> - ${h.action || '진행사항 기록 없음'}
                                </div>
                            `;
                        });
                    } else {
                        historyList.textContent = '기록된 히스토리가 없습니다.';
                    }

                })
                .catch(error => {
                    // 404 에러 처리 (활성 장애가 없는 경우)
                    if (error.message && error.message.includes("Incident not found")) {
                        // 마스터 정보는 표시하고 활성 버튼만 띄움
                         // 마스터 정보만 다시 로드하여 표시하는 로직이 필요하지만, 여기서는 오류 메시지로 대체하고 등록 버튼만 활성화
                         document.getElementById('detailStopId').textContent = arsIdOnly;
                         document.getElementById('detailStopName').textContent = '마스터 정보 로드 실패'; 
                         document.getElementById('actionText').value = '';
                         document.getElementById('detailTime').textContent = 'N/A (신규 등록 가능)';
                         document.getElementById('historyList').textContent = '활성 장애가 없어 히스토리를 불러올 수 없습니다.';

                         btnCreate.style.display = 'block';
                         document.getElementById('actionMessage').className = 'modal-message status-warning';
                         document.getElementById('actionMessage').innerHTML = `⚠️ 해당 ARS ID는 활성 장애 목록에 없습니다. 신규 등록을 진행하세요.`;
                         document.getElementById('actionMessage').style.display = 'block';
                         return;
                    }
                    
                    alert(`상세 정보 로드 중 오류 발생: ${error.message}`);
                    closeModal('detailModal');
                    console.error("Detail fetch error:", error);
                });
        }

        async function updateAction(actionType) {
            const actionText = document.getElementById('actionText').value;
            const actionMessage = document.getElementById('actionMessage');
            actionMessage.style.display = 'none';
            
            if (!actionText) {
                actionMessage.innerHTML = `<span class="error">❌ 오류:</span> ${actionType === 'DELETE' ? '삭제' : actionType === 'CREATE' ? '신규 등록' : '수정'} 시 진행사항을 반드시 입력해야 합니다.`;
                actionMessage.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + `/incident_details/${activeStopId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action_type: actionType, action_text: actionText })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: '응답 본문 없음' }));
                    throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                }
                
                const data = await response.json();

                actionMessage.style.display = 'block';
                actionMessage.innerHTML = `<span class="status-success">✅ 성공:</span> ${data.message}`;
                reloadMainList(); 
                if (actionType === 'DELETE' || actionType === 'CREATE') {
                    setTimeout(() => closeModal('detailModal'), 1000); 
                    activeStopId = null;
                } else {
                    showDetailModal(activeStopId); 
                }
            } catch (error) {
                actionMessage.innerHTML = `<span class="error">❌ 통신 오류:</span> ${error.message}`;
                actionMessage.style.display = 'block';
                console.error("Action post error:", error);
            }
        }

        function deleteIncident() { 
            if(confirm(`정류장 ID ${activeStopId}를 활성 목록에서 삭제하고 조치 완료 상태로 히스토리에 기록하시겠습니까?`)) {
                updateAction('DELETE'); 
            }
        }
        
        function createIncidentFromDetail() { 
            if(confirm(`정류장 ID ${activeStopId}를 활성 장애로 신규 등록하시겠습니까?`)) {
                updateAction('CREATE'); 
            }
        }

        // 페이지 로드 시 활성 인시던트 목록 로드
        window.onload = function() {
            reloadMainList();
        };

    </script>
</body>
</html>