<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì¥ì•  í˜„í™© ê´€ë¦¬</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; margin-bottom: 20px; font-size: 24px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #e9ecef; font-weight: bold; color: #495057; }
        tr:nth-child(even) { background-color: #f1f3f5; }
        tr:hover { background-color: #e2e6ea; cursor: pointer; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .loading { color: #ffc107; font-weight: bold; }
        .btn-group { margin-top: 20px; }
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; font-weight: bold; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-small { padding: 5px 10px; font-size: 14px; }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; position: relative; }
        .modal-content h2 { margin-top: 0; color: #007bff; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }
        textarea, input[type="text"], input[type="number"] { width: 100%; padding: 10px; margin: 8px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-message { margin-top: 10px; padding: 10px; border-radius: 5px; background-color: #e9ecef; display: none; }

        /* Status & Standard Info */
        #statusMessage { margin-bottom: 20px; padding: 10px; border-radius: 5px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        #standardInfo { margin-bottom: 15px; font-size: 16px; font-weight: bold; color: #007bff; }
        
        .active-standard { border: 2px solid #ffc107; background-color: #fff3cd !important; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸšŒ ì‹¤ì‹œê°„ ì¥ì•  í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
    <div id="statusMessage">ë¡œë”© ì¤‘...</div>

    <div id="standardInfo">âœ… í˜„ì¬ ê¸°ì¤€ ì •ë¥˜ì¥: ë¡œë”© ì¤‘...</div>

    <table>
        <thead>
            <tr>
                <th>ì •ë¥˜ì¥ ë²ˆí˜¸</th>
                <th>ê±°ë¦¬ (km)</th>
                <th>ì •ë¥˜ì†Œëª…</th>
                <th>ë°œìƒ ì‹œê°„</th>
                <th>ì¡°ì¹˜ ì‚¬í•­</th>
            </tr>
        </thead>
        <tbody id="incidentTableBody">
            </tbody>
    </table>

    <div class="btn-group">
        <button class="btn btn-secondary" onclick="fetchIncidents(currentStandardId)">ğŸ”„ í˜„í™© ìƒˆë¡œê³ ì¹¨</button>
        <button class="btn btn-primary" onclick="openModal('batchModal')">1. ì¶”ê°€ (ì¥ì•  ëª©ë¡ ì¼ê´„ ë“±ë¡) íŒì—… ì—´ê¸°</button>
        <button class="btn btn-primary" onclick="openModal('manualModal')">2. ì¶”ê°€ (ì¥ì•  ìˆ˜ë™ ë“±ë¡) íŒì—… ì—´ê¸°</button>
    </div>
</div>


<div id="batchModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('batchModal')">&times;</span>
        <h2>ì¥ì•  ëª©ë¡ ì¼ê´„ ë“±ë¡</h2>
        <p>ì¹´ì¹´ì˜¤í†¡ ì¥ì•  ë¡œê·¸ ë“±ì—ì„œ ë³µì‚¬í•œ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (ì˜ˆ: [ì¢…ë¥˜] 02-223 09-27 10:15)</p>
        <textarea id="sampleText" rows="10" placeholder="ì˜ˆì‹œ: [ì•Œëœ°] 02-223 09-26 10:15"></textarea>
        
        <h3 style="margin-top: 15px;">ì¼ê´„ ì ìš©í•  ì¡°ì¹˜ì‚¬í•­</h3>
        <input type="text" id="batchActionText" 
               value="ì§„í–‰ì‚¬í•­ ë¯¸ì…ë ¥" 
               onfocus="if(this.value=='ì§„í–‰ì‚¬í•­ ë¯¸ì…ë ¥') this.value='';" 
               onblur="if(this.value=='') this.value='ì§„í–‰ì‚¬í•­ ë¯¸ì…ë ¥';">
        <div id="batchMessage" class="modal-message"></div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="processBatchAddition()">ëª©ë¡ì— ì¼ê´„ ë“±ë¡</button>
        </div>
    </div>
</div>

<div id="manualModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('manualModal')">&times;</span>
        <h2>ì¥ì•  ìˆ˜ë™ ë“±ë¡/ì—…ë°ì´íŠ¸</h2>
        <p>ìƒˆë¡œìš´ ì¥ì• ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ë“±ë¡í•˜ê±°ë‚˜ ê¸°ì¡´ ì¥ì• ì˜ ì¡°ì¹˜ì‚¬í•­ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</p>
        
        <h3>ì •ë¥˜ì¥ ID (ARS_ID)</h3>
        <input type="text" id="manualArsId" placeholder="ì˜ˆ: 02-223">
        
        <h3>ì¡°ì¹˜ì‚¬í•­</h3>
        <input type="text" id="manualActionText" placeholder="ì˜ˆ: ê¸´ê¸‰ í˜„ì¥ ì¶œë™">
        
        <div id="manualMessage" class="modal-message"></div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="processManualAddition('CREATE')">ì‹ ê·œ ì¥ì•  ë“±ë¡</button>
            <button class="btn btn-secondary" onclick="processManualAddition('UPDATE_ACTION')">ì¡°ì¹˜ì‚¬í•­ ì—…ë°ì´íŠ¸</button>
        </div>
    </div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('detailModal')">&times;</span>
        <h2 id="detailTitle">ìƒì„¸ ì •ë³´ (ID: 00-000)</h2>
        <div id="detailContent"></div>
        
        <h3 style="margin-top: 15px;">ì¡°ì¹˜ ì™„ë£Œ ë° ì‚­ì œ</h3>
        <input type="text" id="deleteActionText" placeholder="ì™„ë£Œ ì‹œ ìµœì¢… ì¡°ì¹˜ì‚¬í•­ì„ ê¸°ë¡í•˜ì„¸ìš”.">
        
        <div id="detailMessage" class="modal-message"></div>
        <div class="btn-group">
            <button class="btn btn-danger" onclick="processDelete()">ì¡°ì¹˜ ì™„ë£Œ ë° ëª©ë¡ ì‚­ì œ</button>
        </div>
    </div>
</div>


<script>
    // ğŸš¨ğŸš¨ğŸš¨ Cloudflare Tunnel ì£¼ì†Œë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”. ğŸš¨ğŸš¨ğŸš¨
    const API_BASE_URL = 'https://proposals-sending-planning-hispanic.trycloudflare.com'; 
    
    let currentStandardId = '02-223'; // ì´ˆê¸° ê¸°ì¤€ ì •ë¥˜ì¥ ID

    // === ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜ ===
    function openModal(id) {
        document.getElementById(id).style.display = 'block';
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
        document.getElementById('batchMessage').style.display = 'none';
        document.getElementById('manualMessage').style.display = 'none';
        document.getElementById('detailMessage').style.display = 'none';
        // ëª¨ë‹¬ ë‹«ì„ ë•Œ ê°’ ì´ˆê¸°í™”
        if (id === 'batchModal') {
            const batchActionText = document.getElementById('batchActionText');
            if (batchActionText.value === '') {
                 batchActionText.value = 'ì§„í–‰ì‚¬í•­ ë¯¸ì…ë ¥';
            }
        }
    }

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    // === ê¸°ì¤€ ì •ë¥˜ì¥ ì„¤ì • ===
    function setActiveStandard(arsId) {
        currentStandardId = arsId;
        localStorage.setItem('standardId', arsId); // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥
        fetchIncidents(arsId);
    }
    
    // === API í˜¸ì¶œ: í™œì„± ì¥ì•  ëª©ë¡ ì¡°íšŒ ===
    function fetchIncidents(standardId) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.innerHTML = 'ë¡œë”© ì¤‘...';
        
        // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ê¸°ì¤€ ID ë¡œë“œ (ì´ˆê¸° ë¡œë“œ ì‹œ)
        if (!standardId) {
            standardId = localStorage.getItem('standardId') || currentStandardId;
            currentStandardId = standardId;
        }

        const url = `${API_BASE_URL}/get_active_incidents?standard_id=${standardId}`;
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('ë„¤íŠ¸ì›Œí¬ ì‘ë‹µ ì˜¤ë¥˜: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.getElementById('incidentTableBody');
                tbody.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

                // 1. ìƒíƒœ ë©”ì‹œì§€ ë° ê¸°ì¤€ ì •ë¥˜ì¥ ì •ë³´ ì—…ë°ì´íŠ¸
                let standardMsg = '';
                if (data.standard_info) {
                    standardMsg = `${data.standard_info['ì •ë¥˜ì†Œëª…']} (${data.standard_info['id']})`;
                    document.getElementById('standardInfo').innerHTML = `âœ… í˜„ì¬ ê¸°ì¤€ ì •ë¥˜ì¥: ${standardMsg} (ìœ„ì¹˜ ë¡œë“œ ì„±ê³µ)`;
                } else {
                    standardMsg = `${standardId}`;
                    document.getElementById('standardInfo').innerHTML = `âš ï¸ í˜„ì¬ ê¸°ì¤€ ì •ë¥˜ì¥: ${standardMsg} (ìœ„ì¹˜ ì •ë³´ ì—†ìŒ)`;
                }
                statusMessage.innerHTML = `<span class="success">âœ… ì„±ê³µ:</span> ${data.incidents.length}ê±´ì˜ í™œì„± ì¥ì• ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`;

                // 2. í…Œì´ë¸” ëª©ë¡ ì±„ìš°ê¸°
                data.incidents.forEach(item => {
                    const row = tbody.insertRow();
                    let distanceDisplay = item.distance_display || 'N/A';
                    let rowClass = item.id === currentStandardId ? 'active-standard' : '';

                    row.className = rowClass;
                    
                    row.onclick = function(event) {
                        // ë‘ ë²ˆ í´ë¦­ ì‹œ ìƒì„¸ íŒì—… ì—´ê¸°
                        if (row.dataset.lastClick && (Date.now() - row.dataset.lastClick) < 300) {
                            openDetailModal(item.id);
                        } else {
                            // í•œ ë²ˆ í´ë¦­ ì‹œ ê¸°ì¤€ ì •ë¥˜ì¥ ì„¤ì •
                            setActiveStandard(item.id);
                        }
                        row.dataset.lastClick = Date.now();
                    };

                    row.insertCell().textContent = item.id;
                    row.insertCell().textContent = distanceDisplay.replace(' km', ''); // km ì œê±°
                    row.insertCell().textContent = item['ì •ë¥˜ì†Œëª…'];
                    row.insertCell().textContent = item.time;
                    row.insertCell().textContent = item.action;
                });
            })
            .catch(error => {
                console.error("API Fetch Error:", error);
                statusMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ì„œë²„ ì—°ê²° ë˜ëŠ” ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨. ${error.message}`;
                document.getElementById('incidentTableBody').innerHTML = '<tr><td colspan="5">ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.</td></tr>';
            });
    }

    // === API í˜¸ì¶œ: 1. ì¥ì•  ëª©ë¡ ì¼ê´„ ë“±ë¡ ===
    function processBatchAddition() {
        const sampleText = document.getElementById('sampleText').value;
        const batchActionText = document.getElementById('batchActionText').value; // ğŸš¨ ìˆ˜ì •ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
        
        const batchMessage = document.getElementById('batchMessage');
        batchMessage.style.display = 'none';
        
        if (!sampleText) {
            batchMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`;
            batchMessage.style.display = 'block';
            return;
        }

        // ğŸš¨ ì¡°ì¹˜ì‚¬í•­ì´ 'ì§„í–‰ì‚¬í•­ ë¯¸ì…ë ¥'ì¸ ê²½ìš°ë¼ë„ ìœ íš¨í•œ ê°’ìœ¼ë¡œ ì„œë²„ì— ì „ì†¡í•©ë‹ˆë‹¤.
        if (!batchActionText.trim()) {
            batchMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ì¡°ì¹˜ì‚¬í•­ì´ ê³µë°±ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ì„ ê·¸ëŒ€ë¡œ ë‘ê±°ë‚˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.`;
            batchMessage.style.display = 'block';
            return;
        }

        fetch(API_BASE_URL + '/process_sample', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                sample_text: sampleText,
                action_text: batchActionText // ì„œë²„ë¡œ ì „ì†¡
            }) 
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                batchMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ${data.details}`;
            } else {
                batchMessage.innerHTML = `<span class="success">âœ… ì„±ê³µ:</span> ${data.message}`;
            }
            batchMessage.style.display = 'block';
            fetchIncidents(currentStandardId); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        })
        .catch(error => {
            batchMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ì„œë²„ í†µì‹  ì‹¤íŒ¨. ${error.message}`;
            batchMessage.style.display = 'block';
        });
    }

    // === API í˜¸ì¶œ: 2. ì¥ì•  ìˆ˜ë™ ë“±ë¡/ì—…ë°ì´íŠ¸ (ê°„ì†Œí™”) ===
    function processManualAddition(actionType) {
        const arsId = document.getElementById('manualArsId').value.trim();
        const actionText = document.getElementById('manualActionText').value.trim();
        const manualMessage = document.getElementById('manualMessage');
        
        manualMessage.style.display = 'none';

        if (!arsId || !actionText) {
            manualMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ì •ë¥˜ì¥ IDì™€ ì¡°ì¹˜ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”.`;
            manualMessage.style.display = 'block';
            return;
        }
        
        fetch(`${API_BASE_URL}/incident_details/${arsId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action_type: actionType,
                action_text: actionText
            }) 
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                manualMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ${data.details}`;
            } else {
                manualMessage.innerHTML = `<span class="success">âœ… ì„±ê³µ:</span> ${data.message}`;
            }
            manualMessage.style.display = 'block';
            fetchIncidents(currentStandardId); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        })
        .catch(error => {
            manualMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ì„œë²„ í†µì‹  ì‹¤íŒ¨.`;
            manualMessage.style.display = 'block';
        });
    }

    // === API í˜¸ì¶œ: 3. ìƒì„¸ ì •ë³´ ë° ì¡°ì¹˜ ì™„ë£Œ (ê°„ì†Œí™”) ===
    let currentDetailId = null;

    function openDetailModal(arsId) {
        currentDetailId = arsId;
        document.getElementById('detailTitle').textContent = `ìƒì„¸ ì •ë³´ (ID: ${arsId})`;
        document.getElementById('detailMessage').style.display = 'none';
        document.getElementById('deleteActionText').value = ''; // ì´ˆê¸°í™”
        
        fetch(`${API_BASE_URL}/incident_details/${arsId}`)
            .then(response => response.json())
            .then(data => {
                let content = `
                    <p><strong>ì •ë¥˜ì†Œëª…:</strong> ${data.master_info['ì •ë¥˜ì†Œëª…']}</p>
                `;
                if (data.active_data) {
                    content += `
                        <p class="error"><strong>í™œì„± ìƒíƒœ:</strong> ACTIVE</p>
                        <p><strong>ë°œìƒ ì‹œê°„:</strong> ${data.active_data.time}</p>
                        <p><strong>í˜„ì¬ ì¡°ì¹˜ì‚¬í•­:</strong> ${data.active_data.action}</p>
                    `;
                } else {
                    content += `<p class="success"><strong>í™œì„± ìƒíƒœ:</strong> COMPLETED (í˜„ì¬ ëª©ë¡ì— ì—†ìŒ)</p>`;
                }

                if (data.history && data.history.length > 0) {
                    content += `<h4>ì´ì „ ì¡°ì¹˜ ê¸°ë¡ (${data.history.length}ê±´)</h4><ul>`;
                    data.history.forEach(h => {
                        content += `<li>${h.START_TIME} ~ ${h.END_TIME}: ${h.ACTION}</li>`;
                    });
                    content += `</ul>`;
                }
                document.getElementById('detailContent').innerHTML = content;
                openModal('detailModal');
            })
            .catch(error => {
                document.getElementById('detailContent').innerHTML = `<p class="error">ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨.</p>`;
                openModal('detailModal');
            });
    }

    function processDelete() {
        const arsId = currentDetailId;
        const actionText = document.getElementById('deleteActionText').value.trim();
        const detailMessage = document.getElementById('detailMessage');

        if (!actionText) {
            detailMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ìµœì¢… ì¡°ì¹˜ì‚¬í•­ì„ ë°˜ë“œì‹œ ì…ë ¥í•˜ì„¸ìš”.`;
            detailMessage.style.display = 'block';
            return;
        }
        
        fetch(`${API_BASE_URL}/incident_details/${arsId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action_type: 'DELETE',
                action_text: actionText
            }) 
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                detailMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ${data.details}`;
            } else {
                detailMessage.innerHTML = `<span class="success">âœ… ì„±ê³µ:</span> ${data.message}`;
                // ì‚­ì œ ì„±ê³µ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    closeModal('detailModal');
                    fetchIncidents(currentStandardId); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                }, 1000);
            }
            detailMessage.style.display = 'block';
        })
        .catch(error => {
            detailMessage.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜:</span> ì„œë²„ í†µì‹  ì‹¤íŒ¨.`;
            detailMessage.style.display = 'block';
        });
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° ê¸°ì¤€ ID ì„¤ì •
    document.addEventListener('DOMContentLoaded', () => {
        // ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ê¸°ì¤€ ID ë¡œë“œ (ìˆìœ¼ë©´ ì‚¬ìš©)
        const savedStandardId = localStorage.getItem('standardId');
        if (savedStandardId) {
            currentStandardId = savedStandardId;
        }
        fetchIncidents(currentStandardId);
    });

</script>

</body>
</html>